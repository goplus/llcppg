name: "Setup llcppg"
description: "Install dependencies, set up Go, set up LLGo, install llcppg"
inputs:
  go-version:
    description: "Go version to install"
    default: "1.23"
  llvm-version:
    description: "LLVM version to install (e.g. 18)"
    default: "18"
  llgo-version:
    description: "LLGo git ref or tag"
    default: "v0.10.0"
runs:
  using: "composite"
  steps:
  - uses: actions/checkout@v4
  - name: Checkout LLGo
    uses: actions/checkout@v4
    with:
      repository: 'goplus/llgo'
      path: '.llgo'
      ref: ${{inputs.llgo-version}}
  - name: Set up Go
    uses: actions/setup-go@v4
    with:
      go-version: ${{inputs.go-version}}
  - name: Install dependencies
    if: runner.os == 'macOS'
    shell: bash
    run: |
      brew update
      brew install llvm@${{matrix.llvm}} bdw-gc openssl libffi libuv
      brew link --force libffi
      echo "$(brew --prefix llvm@${{matrix.llvm}})/bin" >> $GITHUB_PATH

      # llcppg dependencies
      brew install cjson
  - name: Install dependencies
    shell: bash
    if: runner.os == 'Linux'
    run: |
      echo "deb http://apt.llvm.org/$(lsb_release -cs)/ llvm-toolchain-$(lsb_release -cs)-${{matrix.llvm}} main" | sudo tee /etc/apt/sources.list.d/llvm.list
      wget -O - https://apt.llvm.org/llvm-snapshot.gpg.key | sudo apt-key add -
      sudo apt-get update
      sudo apt-get install -y llvm-${{matrix.llvm}}-dev clang-${{matrix.llvm}} libunwind-dev libclang-${{matrix.llvm}}-dev lld-${{matrix.llvm}} pkg-config libgc-dev libssl-dev zlib1g-dev libffi-dev libcjson-dev libuv1-dev
      echo "/usr/lib/llvm-${{matrix.llvm}}/bin" >> $GITHUB_PATH
  - name: Install LLGo
    shell: bash
    working-directory: .llgo
    run: |
      cd compiler
      go install -v ./cmd/...
      export LLGO_ROOT=$GITHUB_WORKSPACE/llgo
      echo "LLGO_ROOT=$LLGO_ROOT" >> $GITHUB_ENV
  - name: Build
    shell: bash
    run: go build -v ./...

  - name: Install llcppg modules
    shell: bash
    run: |
      echo "Using LLGO_ROOT: $LLGO_ROOT"
      bash ./install.sh